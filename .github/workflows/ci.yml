name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  GO_VERSION: '1.24'
  GOLANGCI_LINT_VERSION: 'v1.61'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=5m

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build binary
        run: make dev

      - name: Verify binary works
        run: ./bin/heimdall version

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run tests with race detector
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Display coverage
        run: go tool cover -func=coverage.out

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  codegen:
    name: Code Generation Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install protoc
        run: |
          PROTOC_VERSION=25.1
          curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v${PROTOC_VERSION}/protoc-${PROTOC_VERSION}-linux-x86_64.zip"
          unzip protoc-${PROTOC_VERSION}-linux-x86_64.zip -d $HOME/.local
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install protoc Go plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Install sqlc
        run: go install github.com/sqlc-dev/sqlc/cmd/sqlc@latest

      - name: Generate code
        run: |
          make sqlc
          make protoc

      - name: Check for uncommitted changes
        run: |
          if ! git diff --exit-code; then
            echo "Error: Generated code is out of date. Please run 'make sqlc' and 'make protoc' and commit the changes."
            exit 1
          fi

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          tags: heimdall:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

  migrations:
    name: SQL Migrations
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: heimdall
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: heimdall_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build binary
        run: make dev

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U heimdall; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Run migrations up
        env:
          DATABASE_URL: postgres://heimdall:test_password@localhost:5432/heimdall_test?sslmode=disable
        run: ./bin/heimdall migrate up

      - name: Verify migrations applied
        run: |
          PGPASSWORD=test_password psql -h localhost -U heimdall -d heimdall_test -c "\dt"

      - name: Run migrations down
        env:
          DATABASE_URL: postgres://heimdall:test_password@localhost:5432/heimdall_test?sslmode=disable
        run: ./bin/heimdall migrate down

      - name: Run migrations up again (idempotency check)
        env:
          DATABASE_URL: postgres://heimdall:test_password@localhost:5432/heimdall_test?sslmode=disable
        run: ./bin/heimdall migrate up

      - name: Check migration version
        env:
          DATABASE_URL: postgres://heimdall:test_password@localhost:5432/heimdall_test?sslmode=disable
        run: ./bin/heimdall migrate version
